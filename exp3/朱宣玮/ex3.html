<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电子表格实践I</title>
    <link rel="stylesheet" href="https://unpkg.com/x-data-spreadsheet@1.1.5/dist/xspreadsheet.css">
    <script src="https://unpkg.com/x-data-spreadsheet@1.1.5/dist/xspreadsheet.js"></script>
    <script src="https://unpkg.com/x-data-spreadsheet@1.1.9/dist/locale/zh-cn.js"></script>
    <script src="https://d3js.org/d3.v6.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
        }
        .header h1 {
            color: #2c3e50;
            margin-bottom: 0;
        }
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .spreadsheet-section {
            flex: 1;
            min-width: 400px;
        }
        .visualization-section {
            flex: 1;
            min-width: 400px;
        }
        .controls {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .checkbox-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .checkbox-group input {
            width: 16px;
            height: 16px;
        }
        #xspreadsheet {
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }
        #my_dataviz {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">       
        <div class="content">
            <div class="spreadsheet-section">
                <div class="controls">
                    <div class="checkbox-group">
                        <label><input type="checkbox" class="checkbox" value="barchart">柱状图</label>
                        <label><input type="checkbox" class="checkbox" value="linechart">折线图</label>
                    </div>
                </div>
                <div id="xspreadsheet"></div>
            </div>
            
            <div class="visualization-section">
                <div id="my_dataviz">
                    <div style="text-align: center; color: #7f8c8d;">
                        <p>请选择可视化类型并输入数据</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始化电子表格
        x_spreadsheet.locale("zh-cn");
        const xs = x_spreadsheet("#xspreadsheet", {
            mode: 'edit',
            showToolbar: true,
            showGrid: true,
            showContextmenu: true,
            view: {
                height: () => 500,
                width: () => document.getElementById('xspreadsheet').clientWidth,
            },
            row: {
                len: 15,
                height: 25,
            },
            col: {
                len: 8,
                width: 100,
                indexWidth: 60,
                minWidth: 60,
            },
            style: {
                bgcolor: '#ffffff',
                align: 'left',
                valign: 'middle',
                textwrap: false,
                strike: false,
                underline: false,
                color: '#0a0a0a',
                font: {
                    name: 'Helvetica',
                    size: 10,
                    bold: false,
                    italic: false,
                },
            },
        });

        // 设置初始数据
        xs.cellText(0, 1, "计算机")
          .cellText(0, 2, "法学")
          .cellText(0, 3, "经济学")
          .reRender();
        
        xs.cellText(1, 0, "2017")
          .cellText(1, 1, "23")
          .cellText(1, 2, "15")
          .cellText(1, 3, "32")
          .reRender();
        
        xs.cellText(2, 0, "2018")
          .cellText(2, 1, "36")
          .cellText(2, 2, "26")
          .cellText(2, 3, "28")
          .reRender();
        
        xs.cellText(3, 0, "2019")
          .cellText(3, 1, "23")
          .cellText(3, 2, "33")
          .cellText(3, 3, "41")
          .reRender();
        
        xs.cellText(4, 0, "2020")
          .cellText(4, 1, "22")
          .cellText(4, 2, "10")
          .cellText(4, 3, "35")
          .reRender();

        // 颜色生成函数
        function getColor(idx) {
            const palette = [
                '#5ab1ef', '#ffb980', '#d87a80', '#2ec7c9', '#b6a2de',
                '#8d98b3', '#e5cf0d', '#97b552', '#95706d', '#dc69aa',
                '#07a2a4', '#9a7fd1', '#588dd5', '#f5994e', '#c05050',
                '#59678c', '#c9ab00', '#7eb00a', '#6f5553', '#c14089'
            ];
            return palette[idx % palette.length];
        }

        // 获取电子表格数据
        function getSpreadsheetData() {
            const data = [];
            const yTitle = [];
            const xTitle = [];
            
            // 获取列标题（第一行）
            for (let j = 1; j < 20; j++) {
                const cell = xs.cell(0, j);
                if (!cell || !cell.text || cell.text.trim() === "") {
                    break;
                }
                xTitle.push(cell.text);
            }
            
            // 获取行标题（第一列）和数据
            for (let i = 1; i < 20; i++) {
                const rowTitleCell = xs.cell(i, 0);
                if (!rowTitleCell || !rowTitleCell.text || rowTitleCell.text.trim() === "") {
                    break;
                }
                yTitle.push(rowTitleCell.text);
                
                const rowData = [];
                for (let j = 1; j <= xTitle.length; j++) {
                    const cell = xs.cell(i, j);
                    if (!cell || !cell.text || isNaN(+cell.text)) {
                        rowData.push(0); // 将无效数据设为0
                    } else {
                        rowData.push(+cell.text);
                    }
                }
                data.push(rowData);
            }
            
            return { data, xTitle, yTitle };
        }

        // 绘制柱状图
        function drawBarChart(data, xTitle, yTitle) {
            d3.select("#my_dataviz").html("");
            
            const margin = { top: 40, right: 150, bottom: 60, left: 50 };
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            
            const svg = d3.select("#my_dataviz")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // 计算最大值
            let maxValue = 0;
            data.forEach(row => {
                row.forEach(value => {
                    if (value > maxValue) maxValue = value;
                });
            });
            
            // 准备分组柱状图数据
            const chartData = [];
            yTitle.forEach((year, i) => {
                const yearData = { year: year };
                xTitle.forEach((category, j) => {
                    yearData[category] = data[i][j];
                });
                chartData.push(yearData);
            });
            
            // X轴 - 按年份分组
            const x0 = d3.scaleBand()
                .domain(yTitle)
                .range([0, width])
                .padding(0.2);
            
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x0))
                .selectAll("text")
                .style("text-anchor", "middle");
            
            // Y轴
            const y = d3.scaleLinear()
                .domain([0, maxValue * 1.1])
                .range([height, 0]);
            
            svg.append("g")
                .call(d3.axisLeft(y));
            
            // 子组 - 按类别分组
            const x1 = d3.scaleBand()
                .domain(xTitle)
                .range([0, x0.bandwidth()])
                .padding(0.05);
            
            // 绘制柱状图
            svg.append("g")
                .selectAll("g")
                .data(chartData)
                .enter()
                .append("g")
                .attr("transform", d => `translate(${x0(d.year)}, 0)`)
                .selectAll("rect")
                .data(d => xTitle.map(key => ({ key, value: d[key] })))
                .enter()
                .append("rect")
                .attr("x", d => x1(d.key))
                .attr("y", d => y(d.value))
                .attr("width", x1.bandwidth())
                .attr("height", d => height - y(d.value))
                .attr("fill", (d, i) => getColor(i));
            
            // 添加数值标签
            svg.selectAll(".bar-label")
                .data(chartData.flatMap(d => 
                    xTitle.map(key => ({ 
                        key, 
                        value: d[key],
                        x: x0(d.year) + x1(key) + x1.bandwidth() / 2,
                        y: y(d[key]) - 5
                    }))
                ))
                .enter()
                .append("text")
                .attr("class", "bar-label")
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .text(d => d.value)
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .style("font-weight", "bold");
            
            // 添加图例
            const legend = svg.selectAll(".legend")
                .data(xTitle)
                .enter()
                .append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(${width + 20},${i * 25})`);
            
            legend.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", 15)
                .attr("height", 15)
                .style("fill", (d, i) => getColor(i));
            
            legend.append("text")
                .attr("x", 25)
                .attr("y", 12)
                .text(d => d)
                .style("font-size", "12px")
                .attr("alignment-baseline", "middle");
            
            // 添加标题
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", -10)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .text("柱状图");
        }

        // 绘制折线图
        function drawLineChart(data, xTitle, yTitle) {
            d3.select("#my_dataviz").html("");
            
            const margin = { top: 40, right: 150, bottom: 60, left: 50 };
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            
            const svg = d3.select("#my_dataviz")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // 计算最大值
            let maxValue = 0;
            data.forEach(row => {
                row.forEach(value => {
                    if (value > maxValue) maxValue = value;
                });
            });
            
            // X轴
            const x = d3.scalePoint()
                .domain(yTitle)
                .range([0, width]);
            
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));
            
            // Y轴
            const y = d3.scaleLinear()
                .domain([0, maxValue * 1.1])
                .range([height, 0]);
            
            svg.append("g")
                .call(d3.axisLeft(y));
            
            // 绘制折线
            const line = d3.line()
                .x((d, i) => x(yTitle[i]))
                .y(d => y(d));
            
            xTitle.forEach((category, idx) => {
                const values = data.map(row => row[idx]);
                
                svg.append("path")
                    .datum(values)
                    .attr("fill", "none")
                    .attr("stroke", getColor(idx))
                    .attr("stroke-width", 2)
                    .attr("d", line);
                
                // 添加数据点
                svg.selectAll(`.dot-${idx}`)
                    .data(values)
                    .enter()
                    .append("circle")
                    .attr("class", `dot-${idx}`)
                    .attr("cx", (d, i) => x(yTitle[i]))
                    .attr("cy", d => y(d))
                    .attr("r", 4)
                    .attr("fill", getColor(idx));
            });
            
            // 添加图例
            const legend = svg.selectAll(".legend")
                .data(xTitle)
                .enter()
                .append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(${width + 20},${i * 25})`);
            
            legend.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", 15)
                .attr("height", 15)
                .style("fill", (d, i) => getColor(i));
            
            legend.append("text")
                .attr("x", 25)
                .attr("y", 12)
                .text(d => d)
                .style("font-size", "12px")
                .attr("alignment-baseline", "middle");
            
            // 添加标题
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", -10)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .text("折线图");
        }

        // 更新可视化
        function update() {
            const barChartChecked = d3.select('input[value="barchart"]').property("checked");
            const lineChartChecked = d3.select('input[value="linechart"]').property("checked");
            
            if (!barChartChecked && !lineChartChecked) {
                d3.select("#my_dataviz").html("<div style='text-align: center; color: #7f8c8d;'><p>请选择可视化类型并输入数据</p></div>");
                return;
            }
            
            const { data, xTitle, yTitle } = getSpreadsheetData();
            
            // 确保数据有效
            if (data.length === 0 || xTitle.length === 0 || yTitle.length === 0) {
                d3.select("#my_dataviz").html("<div style='text-align: center; color: #e74c3c;'><p>数据格式不正确，请检查电子表格</p></div>");
                return;
            }
            
            if (barChartChecked) {
                drawBarChart(data, xTitle, yTitle);
            } else if (lineChartChecked) {
                drawLineChart(data, xTitle, yTitle);
            }
        }

        // 添加事件监听器
        xs.on('cell-edited', update);
        d3.selectAll(".checkbox").on("change", function() {
            // 确保只有一个复选框被选中
            if (this.value === "barchart" && this.checked) {
                d3.select('input[value="linechart"]').property("checked", false);
            } else if (this.value === "linechart" && this.checked) {
                d3.select('input[value="barchart"]').property("checked", false);
            }
            update();
        });
    </script>
</body>
</html>